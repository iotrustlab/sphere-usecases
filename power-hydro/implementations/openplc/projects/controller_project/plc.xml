<?xml version='1.0' encoding='utf-8'?>
<project xmlns:ns1="http://www.plcopen.org/xml/tc6_0201" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://www.plcopen.org/xml/tc6_0201">
  <fileHeader companyName="CrossPLC" productName="PS_Hydro_Controller" productVersion="1.0" creationDateTime="2026-02-10T12:27:58" />
  <contentHeader name="PS_Hydro_Controller" modificationDateTime="2026-02-10T12:27:58">
    <coordinateInfo>
      <fbd>
        <scaling x="10" y="10" />
      </fbd>
      <ld>
        <scaling x="10" y="10" />
      </ld>
      <sfc>
        <scaling x="10" y="10" />
      </sfc>
    </coordinateInfo>
  </contentHeader>
  <types>
    <dataTypes />
    <pous>
      <pou name="HydroController" pouType="program">
        <interface>
          <inputVars>
            <variable name="in_Start_Cmd">
              <type>
                <BOOL;              (* Start pushbutton *) />
              </type>
            </variable>
            <variable name="in_Stop_Cmd">
              <type>
                <BOOL;               (* Stop pushbutton *) />
              </type>
            </variable>
            <variable name="in_Reset_Cmd">
              <type>
                <BOOL;              (* Trip reset pushbutton *) />
              </type>
            </variable>
            <variable name="in_Mode_Auto">
              <type>
                <BOOL;              (* Auto mode enable *) />
              </type>
            </variable>
            <variable name="in_Run_Enable">
              <type>
                <BOOL;             (* Run permissive *) />
              </type>
            </variable>
            <variable name="in_Power_Setpoint">
              <type>
                <INT;          (* 0-1000 = 0-100 MW *) />
              </type>
            </variable>
            <variable name="in_Gate_Pos">
              <type>
                <INT;                (* Gate position 0-1000 = 0-100% *) />
              </type>
            </variable>
            <variable name="in_Res_Level">
              <type>
                <INT;               (* Reservoir level 0-3000 = 0-30.00 m *) />
              </type>
            </variable>
            <variable name="in_Head">
              <type>
                <INT;                    (* Head 0-1500 = 0-150.0 m *) />
              </type>
            </variable>
            <variable name="in_Flow">
              <type>
                <INT;                    (* Flow 0-1500 = 0-150.0 m3/s *) />
              </type>
            </variable>
            <variable name="in_Pressure">
              <type>
                <INT;                (* Pressure kPa *) />
              </type>
            </variable>
            <variable name="in_Speed_Pct">
              <type>
                <INT;               (* Speed 0-1500 = 0-150.0% *) />
              </type>
            </variable>
            <variable name="in_Freq_Hz">
              <type>
                <INT;                 (* Frequency 5500-6500 = 55-65 Hz *) />
              </type>
            </variable>
            <variable name="in_Power_MW">
              <type>
                <INT;                (* Power 0-1000 = 0-100 MW *) />
              </type>
            </variable>
            <variable name="in_Breaker_Sts">
              <type>
                <BOOL;            (* Breaker closed status *) />
              </type>
            </variable>
            <variable name="in_Spill_Sts">
              <type>
                <BOOL;              (* Spillway open status *) />
              </type>
            </variable>
          </inputVars>
          <outputVars>
            <variable name="out_Gate_Cmd">
              <type>
                <INT;               (* Gate command 0-1000 = 0-100% *) />
              </type>
            </variable>
            <variable name="out_Power_Setpoint">
              <type>
                <INT;         (* Power setpoint passthrough *) />
              </type>
            </variable>
            <variable name="out_Breaker_Cmd">
              <type>
                <BOOL;           (* Breaker close command *) />
              </type>
            </variable>
            <variable name="out_Spill_Cmd">
              <type>
                <BOOL;             (* Spillway open command *) />
              </type>
            </variable>
            <variable name="out_State_Idle">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_State_Startup">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_State_Running">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_State_Shutdown">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_State_Tripped">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_Permissives_Ready">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_Trip_Overspeed">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_Trip_Overpressure">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_Trip_LowHead">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_Trip_Manual">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_Alarm_GateMismatch">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_Alarm_BreakerMismatch">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="out_Alarm_LowLevel">
              <type>
                <BOOL />
              </type>
            </variable>
          </outputVars>
          <localVars>
            <variable name="State">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="STATE_IDLE">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="STATE_STARTUP">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="STATE_RUNNING">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="STATE_SHUTDOWN">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="STATE_TRIPPED">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="Perm_Level_OK">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Perm_Head_OK">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Perm_No_Trips">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Perm_Run_Enable">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="All_Permissives">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Trip_Overspeed_Latch">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Trip_Overpressure_Latch">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Trip_LowHead_Latch">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Trip_Manual_Latch">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Any_Trip">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="No_Load_Gate_Pct">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Sync_Speed_Low">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Sync_Speed_High">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Min_Power_MW">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Kp_Gate">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Gate_Shutdown_Rate">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Gate_Emerg_Rate">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Overspeed_Trip_Pct">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Overpressure_Trip_kPa">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Min_Head_m">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Low_Level_m">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Gate_Mismatch_Pct">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Gate_Mismatch_Delay">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="Breaker_Mismatch_Delay">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="Gate_Mismatch_Timer">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="Breaker_Mismatch_Timer">
              <type>
                <INT />
              </type>
            </variable>
            <variable name="Gate_Pos_Pct">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Gate_Cmd_Pct">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Res_Level_m">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Head_m">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Flow_m3s">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Pressure_kPa">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Speed_Pct">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Freq_Hz">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Power_MW">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Power_Setpoint_MW">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Power_Error">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Gate_Adjustment">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Gate_Error">
              <type>
                <REAL />
              </type>
            </variable>
            <variable name="Start_Cmd_Prev">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Stop_Cmd_Prev">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Reset_Cmd_Prev">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Start_Rising">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Stop_Rising">
              <type>
                <BOOL />
              </type>
            </variable>
            <variable name="Reset_Rising">
              <type>
                <BOOL />
              </type>
            </variable>
          </localVars>
        </interface>
        <body>
          <ST>
            <xhtml:p>(* 1. SCALE INPUTS *)
  Gate_Pos_Pct := INT_TO_REAL(in_Gate_Pos) / 10.0;
  Res_Level_m := INT_TO_REAL(in_Res_Level) / 100.0;
  Head_m := INT_TO_REAL(in_Head) / 10.0;
  Flow_m3s := INT_TO_REAL(in_Flow) / 10.0;
  Pressure_kPa := INT_TO_REAL(in_Pressure);
  Speed_Pct := INT_TO_REAL(in_Speed_Pct) / 10.0;
  Freq_Hz := INT_TO_REAL(in_Freq_Hz) / 100.0;
  Power_MW := INT_TO_REAL(in_Power_MW) / 10.0;
  Power_Setpoint_MW := INT_TO_REAL(in_Power_Setpoint) / 10.0;

  (* 2. EDGE DETECTION FOR COMMANDS *)
  Start_Rising := in_Start_Cmd AND NOT Start_Cmd_Prev;
  Stop_Rising := in_Stop_Cmd AND NOT Stop_Cmd_Prev;
  Reset_Rising := in_Reset_Cmd AND NOT Reset_Cmd_Prev;
  Start_Cmd_Prev := in_Start_Cmd;
  Stop_Cmd_Prev := in_Stop_Cmd;
  Reset_Cmd_Prev := in_Reset_Cmd;

  (* 3. TRIP DETECTION *)
  IF Speed_Pct &gt; Overspeed_Trip_Pct THEN
    Trip_Overspeed_Latch := TRUE;
  END_IF;

  IF Pressure_kPa &gt; Overpressure_Trip_kPa THEN
    Trip_Overpressure_Latch := TRUE;
  END_IF;

  IF Head_m &lt; Min_Head_m AND State = STATE_RUNNING THEN
    Trip_LowHead_Latch := TRUE;
  END_IF;

  Any_Trip := Trip_Overspeed_Latch OR Trip_Overpressure_Latch OR
              Trip_LowHead_Latch OR Trip_Manual_Latch;

  (* 4. PERMISSIVE CHECKS *)
  Perm_Level_OK := Res_Level_m &gt; Low_Level_m;
  Perm_Head_OK := Head_m &gt;= Min_Head_m;
  Perm_No_Trips := NOT Any_Trip;
  Perm_Run_Enable := in_Run_Enable;

  All_Permissives := Perm_Level_OK AND Perm_Head_OK AND
                     Perm_No_Trips AND Perm_Run_Enable;

  (* 5. STATE MACHINE *)
  CASE State OF

    0: (* STATE_IDLE *)
      Gate_Cmd_Pct := 0.0;
      out_Breaker_Cmd := FALSE;
      out_Spill_Cmd := FALSE;

      IF Start_Rising AND All_Permissives THEN
        State := STATE_STARTUP;
      END_IF;

    1: (* STATE_STARTUP *)
      IF Gate_Cmd_Pct &lt; No_Load_Gate_Pct THEN
        Gate_Cmd_Pct := Gate_Cmd_Pct + 1.0;
      ELSE
        Gate_Cmd_Pct := No_Load_Gate_Pct;
      END_IF;

      IF Speed_Pct &gt;= Sync_Speed_Low AND Speed_Pct &lt;= Sync_Speed_High THEN
        out_Breaker_Cmd := TRUE;
        IF in_Breaker_Sts THEN
          State := STATE_RUNNING;
        END_IF;
      END_IF;

      IF Any_Trip THEN
        State := STATE_TRIPPED;
      END_IF;

      IF Stop_Rising THEN
        State := STATE_SHUTDOWN;
      END_IF;

    2: (* STATE_RUNNING *)
      Power_Error := Power_Setpoint_MW - Power_MW;
      Gate_Adjustment := Kp_Gate * Power_Error;
      Gate_Cmd_Pct := Gate_Cmd_Pct + Gate_Adjustment;

      IF Gate_Cmd_Pct &lt; 0.0 THEN
        Gate_Cmd_Pct := 0.0;
      END_IF;
      IF Gate_Cmd_Pct &gt; 100.0 THEN
        Gate_Cmd_Pct := 100.0;
      END_IF;

      out_Breaker_Cmd := TRUE;

      IF Any_Trip THEN
        State := STATE_TRIPPED;
      END_IF;

      IF Stop_Rising THEN
        State := STATE_SHUTDOWN;
      END_IF;

    3: (* STATE_SHUTDOWN *)
      Gate_Cmd_Pct := Gate_Cmd_Pct - Gate_Shutdown_Rate;
      IF Gate_Cmd_Pct &lt; 0.0 THEN
        Gate_Cmd_Pct := 0.0;
      END_IF;

      IF Power_MW &lt; Min_Power_MW THEN
        out_Breaker_Cmd := FALSE;
      END_IF;

      IF Gate_Cmd_Pct &lt;= 0.0 AND NOT in_Breaker_Sts THEN
        State := STATE_IDLE;
      END_IF;

      IF Any_Trip THEN
        State := STATE_TRIPPED;
      END_IF;

    4: (* STATE_TRIPPED *)
      out_Breaker_Cmd := FALSE;

      Gate_Cmd_Pct := Gate_Cmd_Pct - Gate_Emerg_Rate;
      IF Gate_Cmd_Pct &lt; 0.0 THEN
        Gate_Cmd_Pct := 0.0;
      END_IF;

      IF Trip_Overspeed_Latch THEN
        out_Spill_Cmd := TRUE;
      END_IF;

      IF Reset_Rising AND Gate_Cmd_Pct &lt;= 0.0 AND NOT in_Breaker_Sts THEN
        Trip_Overspeed_Latch := FALSE;
        Trip_Overpressure_Latch := FALSE;
        Trip_LowHead_Latch := FALSE;
        Trip_Manual_Latch := FALSE;
        out_Spill_Cmd := FALSE;
        State := STATE_IDLE;
      END_IF;

  END_CASE;

  (* 6. MISMATCH ALARM LOGIC *)
  Gate_Error := Gate_Cmd_Pct - Gate_Pos_Pct;
  IF Gate_Error &lt; 0.0 THEN
    Gate_Error := -Gate_Error;
  END_IF;
  IF Gate_Error &gt; Gate_Mismatch_Pct THEN
    Gate_Mismatch_Timer := Gate_Mismatch_Timer + 1;
    IF Gate_Mismatch_Timer &gt;= Gate_Mismatch_Delay THEN
      out_Alarm_GateMismatch := TRUE;
    END_IF;
  ELSE
    Gate_Mismatch_Timer := 0;
    out_Alarm_GateMismatch := FALSE;
  END_IF;

  IF out_Breaker_Cmd &lt;&gt; in_Breaker_Sts THEN
    Breaker_Mismatch_Timer := Breaker_Mismatch_Timer + 1;
    IF Breaker_Mismatch_Timer &gt;= Breaker_Mismatch_Delay THEN
      out_Alarm_BreakerMismatch := TRUE;
    END_IF;
  ELSE
    Breaker_Mismatch_Timer := 0;
    out_Alarm_BreakerMismatch := FALSE;
  END_IF;

  out_Alarm_LowLevel := Res_Level_m &lt; Low_Level_m;

  (* 7. WRITE OUTPUTS *)
  out_Gate_Cmd := REAL_TO_INT(Gate_Cmd_Pct * 10.0);
  out_Power_Setpoint := in_Power_Setpoint;

  out_State_Idle := (State = STATE_IDLE);
  out_State_Startup := (State = STATE_STARTUP);
  out_State_Running := (State = STATE_RUNNING);
  out_State_Shutdown := (State = STATE_SHUTDOWN);
  out_State_Tripped := (State = STATE_TRIPPED);
  out_Permissives_Ready := All_Permissives;

  out_Trip_Overspeed := Trip_Overspeed_Latch;
  out_Trip_Overpressure := Trip_Overpressure_Latch;
  out_Trip_LowHead := Trip_LowHead_Latch;
  out_Trip_Manual := Trip_Manual_Latch;</xhtml:p>
          </ST>
        </body>
      </pou>
    </pous>
  </types>
  <instances>
    <configurations>
      <configuration name="Config0">
        <resource name="Res0">
          <task name="task_HydroController" priority="0" interval="T#100ms" />
          <pouInstance name="HydroController_instance" typeName="HydroController" />
        </resource>
      </configuration>
    </configurations>
  </instances>
</project>
