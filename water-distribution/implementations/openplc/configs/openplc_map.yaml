# OpenPLC Backend Mapping: Water Distribution UC0
#
# Maps each canonical tag name from tag_contract.yaml to its Modbus
# register type and address for the OpenPLC backend.
#
# NOTE: These are placeholder addresses — no PLC program exists yet.
# Address assignments are structurally valid but will need updating
# when an actual OpenPLC program is developed.
#
# Modbus register types:
#   coil              - Digital output (function codes 1/5/15)
#   discrete_input    - Digital input (function code 2)
#   holding_register  - Analog output (function codes 3/6/16)
#   input_register    - Analog input (function code 4)
#
# OpenPLC IEC address convention:
#   %QX<byte>.<bit> -> coil address = byte*8 + bit
#   %IX<byte>.<bit> -> discrete_input address = byte*8 + bit
#   %QW<n>          -> holding_register address = n
#   %IW<n>          -> input_register address = n

api_version: sphere.mergetb.io/v1
kind: BackendMapping
metadata:
  backend: openplc
  protocol: modbus_tcp
  status: placeholder  # no PLC program exists yet

mappings:
  # ─── Supply Line ────────────────────────────────────────────────────────
  # Analog sensors (input registers) - simulator -> controller
  Supply_Tank_Level:
    register_type: input_register
    address: 70             # %IW70
    iec_address: "%IW70"
    scale: 1.0

  Supply_Pump_Flow:
    register_type: input_register
    address: 71             # %IW71
    iec_address: "%IW71"
    scale: 1.0

  Supply_NaOCl_Level:
    register_type: input_register
    address: 72             # %IW72
    iec_address: "%IW72"
    scale: 1.0

  Supply_NH4Cl_Level:
    register_type: input_register
    address: 73             # %IW73
    iec_address: "%IW73"
    scale: 1.0

  # Analog actuator (holding register) - controller -> simulator
  Supply_Pump_Speed:
    register_type: holding_register
    address: 100            # %QW100
    iec_address: "%QW100"
    scale: 1.0

  # Digital commands (coils) - controller -> simulator
  Supply_Tank_Valve:
    register_type: coil
    address: 40             # %QX5.0
    iec_address: "%QX5.0"

  # Digital status (discrete inputs) - simulator -> controller
  Supply_Pump_Sts:
    register_type: discrete_input
    address: 16             # %IX2.0
    iec_address: "%IX2.0"

  Supply_Mixer_Sts:
    register_type: discrete_input
    address: 17             # %IX2.1
    iec_address: "%IX2.1"

  Supply_Tank_Valve_Sts:
    register_type: discrete_input
    address: 18             # %IX2.2
    iec_address: "%IX2.2"

  # ─── Distribution Grid ─────────────────────────────────────────────────
  # Analog sensors (input registers) - simulator -> controller
  Grid_Elev_Tank_Level:
    register_type: input_register
    address: 74             # %IW74
    iec_address: "%IW74"
    scale: 1.0

  Grid_Consum_Tank_Level:
    register_type: input_register
    address: 75             # %IW75
    iec_address: "%IW75"
    scale: 1.0

  # Digital command (coil) - controller -> simulator
  Grid_Elev_Valve:
    register_type: coil
    address: 41             # %QX5.1
    iec_address: "%QX5.1"

  # Digital status (discrete input) - simulator -> controller
  Grid_Elev_Valve_Sts:
    register_type: discrete_input
    address: 19             # %IX2.3
    iec_address: "%IX2.3"

  # ─── Return Water System ───────────────────────────────────────────────
  # Analog sensors (input registers) - simulator -> controller
  RWS_Tank_Level:
    register_type: input_register
    address: 76             # %IW76
    iec_address: "%IW76"
    scale: 1.0

  # Analog actuator (holding register) - controller -> simulator
  RWS_Pump_Speed:
    register_type: holding_register
    address: 101            # %QW101
    iec_address: "%QW101"
    scale: 1.0

  # Digital command (coil) - controller -> simulator
  RWS_Tank_Valve:
    register_type: coil
    address: 42             # %QX5.2
    iec_address: "%QX5.2"

  # Digital status (discrete inputs) - simulator -> controller
  RWS_Pump_Sts:
    register_type: discrete_input
    address: 20             # %IX2.4
    iec_address: "%IX2.4"

  RWS_Tank_Valve_Sts:
    register_type: discrete_input
    address: 21             # %IX2.5
    iec_address: "%IX2.5"

  # ─── System State ──────────────────────────────────────────────────────
  SYS_IDLE:
    register_type: coil
    address: 56             # %QX7.0
    iec_address: "%QX7.0"

  SYS_RUNNING:
    register_type: coil
    address: 57             # %QX7.1
    iec_address: "%QX7.1"

  # ─── Alarms ────────────────────────────────────────────────────────────
  Alarm_Supply_Tank_HH:
    register_type: coil
    address: 64             # %QX8.0
    iec_address: "%QX8.0"

  # ─── Reserved Address Ranges ───────────────────────────────────────────
  # Coils:
  #   %QX5.0-5.2  (40-42)  Process actuator commands
  #   %QX7.0-7.1  (56-57)  System state
  #   %QX8.0      (64)     Alarms
  # Discrete inputs:
  #   %IX2.0-2.5  (16-21)  Process status feedback
  # Holding registers:
  #   %QW100-101           Speed setpoints
  # Input registers:
  #   %IW70-76             Analog sensor values
